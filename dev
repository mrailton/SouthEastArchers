#!/bin/bash

##############################################################################
# South East Archers Development Tool
# Simple shell script for managing development tasks
##############################################################################

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Functions for output
info() { echo -e "${BLUE}ğŸ“${NC} $1"; }
success() { echo -e "${GREEN}âœ…${NC} $1"; }
error() { echo -e "${RED}âŒ${NC} $1"; }
warn() { echo -e "${YELLOW}âš ï¸ ${NC}$1"; }
section() { echo -e "\n${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n${BLUE}$1${NC}\n"; }

# Display help
show_help() {
    cat << 'HELP'
South East Archers Development Tool

USAGE:
  ./dev.sh <command> [options]

COMMANDS:

  DOCKER:
    up              Start all Docker services
    down            Stop all Docker services
    restart         Restart services
    logs            View service logs (use -f for follow)
    ps              Show running services
    shell           Open shell in app container
    build           Rebuild Docker image

  DATABASE:
    db:init         Initialize database
    db:migrate      Create database migration
    db:upgrade      Apply migrations
    db:downgrade    Rollback last migration
    db:reset        Reset database (destructive!)

  USER:
    user:create     Create new user
    user:list       List all users
    user:delete     Delete user

  ASSETS:
    assets:build    Build CSS and JS assets
    assets:watch    Watch and rebuild assets on changes

  TESTING:
    test            Run test suite
    test:file       Run specific test file
    test:coverage   Generate coverage report
    lint            Run code linting
    format          Format code with black/isort

  DEVELOPMENT:
    status          Show environment status
    stats           Show application statistics
    clean           Clean cache and temp files

  QUICK:
    start           Quick start (up + db init)
    stop            Quick stop
    info            Show project info

EXAMPLES:
  ./dev.sh start                    # Quick start
  ./dev.sh docker up                # Start services
  ./dev.sh docker logs -f           # View logs
  ./dev.sh test                     # Run tests
  ./dev.sh user:create              # Create user
  ./dev.sh db:migrate -m "message"  # Create migration

HELP
}

# Check if Docker is running
check_docker() {
    if ! docker-compose ps > /dev/null 2>&1; then
        error "Docker services not running"
        error "Run: ./dev.sh docker up"
        exit 1
    fi
}

# Execute Docker command
docker_exec() {
    docker-compose exec -T "$@"
}

##############################################################################
# DOCKER COMMANDS
##############################################################################

docker_up() {
    section "Starting Docker services"
    docker-compose up -d
    sleep 5
    success "Services started!"
    info "App: http://localhost:5000"
    info "MailHog: http://localhost:8025"
    info "MySQL: localhost:3306"
}

docker_down() {
    section "Stopping Docker services"
    docker-compose down
    success "Services stopped!"
}

docker_restart() {
    section "Restarting Docker services"
    docker-compose restart
    success "Services restarted!"
}

docker_logs() {
    local service="app"
    local follow=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            -f|--follow) follow="-f"; shift ;;
            -s|--service) service="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    docker-compose logs $follow "$service"
}

docker_ps() {
    docker-compose ps
}

docker_shell() {
    section "Opening shell in app container"
    docker-compose exec -it app bash
}

docker_build() {
    section "Building Docker image"
    docker-compose build --no-cache
    success "Docker image built!"
}

##############################################################################
# DATABASE COMMANDS
##############################################################################

db_init() {
    check_docker
    section "Initializing database"
    docker_exec app flask db upgrade
    success "Database initialized!"
}

db_migrate() {
    check_docker
    local message="${1:-New migration}"
    section "Creating migration: $message"
    docker_exec app flask db migrate -m "$message"
    success "Migration created!"
}

db_upgrade() {
    check_docker
    section "Applying migrations"
    docker_exec app flask db upgrade
    success "Migrations applied!"
}

db_downgrade() {
    check_docker
    read -p "Rollback last migration? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        section "Rolling back migration"
        docker_exec app flask db downgrade
        success "Migration rolled back!"
    fi
}

db_reset() {
    warn "This will DELETE all data!"
    read -p "Type 'reset' to confirm: " confirm
    if [ "$confirm" = "reset" ]; then
        section "Resetting database"
        docker-compose down -v
        docker-compose up -d
        sleep 10
        docker_exec app flask db upgrade
        success "Database reset!"
    else
        error "Reset cancelled"
    fi
}

##############################################################################
# USER COMMANDS
##############################################################################

user_create() {
    check_docker
    section "Creating new user"
    if [ "$1" = "--admin" ]; then
        docker-compose exec -it app python cli.py create-user --admin
    else
        docker-compose exec -it app python cli.py create-user
    fi
}

user_list() {
    check_docker
    section "All users"
    docker_exec app python cli.py list-users
}

user_delete() {
    check_docker
    read -p "User ID to delete: " user_id
    read -p "Are you sure? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        section "Deleting user"
        docker_exec app python cli.py delete-user --user-id "$user_id"
        success "User deleted!"
    fi
}

##############################################################################
# TEST COMMANDS
##############################################################################

test_run() {
    check_docker
    local flags=""
    local has_coverage=false

    while [[ $# -gt 0 ]]; do
        case $1 in
            -c|--coverage) flags="$flags --cov=app --cov-report=term-missing --no-cov-on-fail"; has_coverage=true; shift ;;
            -v|--verbose) flags="$flags -v"; shift ;;
            *) shift ;;
        esac
    done

    section "Running tests"
    docker_exec app pytest $flags

    # Clean up coverage files if coverage was run
    if [ "$has_coverage" = true ]; then
        rm -f .coverage .coveragerc 2>/dev/null
    fi

    success "Tests complete!"
}

test_file() {
    check_docker
    local file="${1:-tests/}"
    section "Running tests for $file"
    docker_exec app pytest "$file" -v
}

test_coverage() {
    check_docker
    section "Coverage report"
    docker_exec app bash -c "pytest --cov=app --cov-report=term-missing && rm -f .coverage"
}

test_lint() {
    check_docker
    section "Running linting"
    docker_exec app flake8 app/ tests/
    success "Linting complete!"
}

test_format() {
    check_docker
    section "Formatting code"
    docker_exec app black app/ tests/
    docker_exec app isort app/ tests/
    success "Code formatted!"
}

##############################################################################
# DEVELOPMENT COMMANDS
##############################################################################

dev_status() {
    section "Development Environment Status"
    echo "Docker services:"
    docker-compose ps
    
    echo ""
    if docker-compose exec -T mysql mysql -u sea_user -psea_password -e 'SELECT 1' 2>/dev/null; then
        success "Database: Connected"
    else
        error "Database: Not connected"
    fi
    
    echo ""
    info "Services:"
    info "  App: http://localhost:5000"
    info "  MailHog: http://localhost:8025"
    info "  MySQL: localhost:3306"
}

dev_stats() {
    check_docker
    section "Application Statistics"
    docker_exec app python cli.py show-stats
}

dev_clean() {
    section "Cleaning up"
    find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
    find . -type f -name '*.pyc' -delete 2>/dev/null || true
    rm -rf .pytest_cache 2>/dev/null || true
    success "Cleanup complete!"
}

##############################################################################
# ASSET COMMANDS
##############################################################################

assets_build() {
    section "Building CSS and JS assets"
    npm run build
    success "Assets built successfully!"
}

assets_watch() {
    section "Watching CSS and JS assets for changes"
    info "Press Ctrl+C to stop watching"
    npm run dev
}

##############################################################################
# QUICK COMMANDS
##############################################################################

quick_start() {
    section "ğŸš€ Quick Start"
    
    info "Starting services..."
    docker_up
    
    sleep 5
    info "Initializing database..."
    docker_exec app flask db upgrade
    
    echo ""
    success "Ready to develop!"
    echo ""
    info "Next steps:"
    info "  1. Create admin user: ./dev.sh user:create --admin"
    info "  2. Open: http://localhost:5000"
    info "  3. View logs: ./dev.sh docker logs -f"
}

quick_stop() {
    section "Stopping services"
    docker_down
}

show_info() {
    cat << 'INFO'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     South East Archers Development Tool               â•‘
â•‘                                                        â•‘
â•‘  Tech Stack:                                           â•‘
â•‘  â€¢ Flask 3.0.0 with Python 3.14                       â•‘
â•‘  â€¢ MySQL 8.0 database                                  â•‘
â•‘  â€¢ Tailwind CSS 4.1 + Alpine.js 3                      â•‘
â•‘  â€¢ Docker & Docker Compose                             â•‘
â•‘                                                        â•‘
â•‘  Quick Start:                                          â•‘
â•‘  $ ./dev.sh start                                      â•‘
â•‘  $ ./dev.sh user:create --admin                        â•‘
â•‘  $ ./dev.sh docker logs -f                             â•‘
â•‘                                                        â•‘
â•‘  Documentation:                                        â•‘
â•‘  â€¢ README.md - Full documentation                      â•‘
â•‘  â€¢ DEV_TOOL.md - Tool documentation                    â•‘
â•‘  â€¢ DEPLOYMENT.md - Production deployment               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INFO
}

##############################################################################
# MAIN
##############################################################################

main() {
    local command="${1:-help}"
    
    case "$command" in
        # Docker
        docker:up|up) docker_up; ;;
        docker:down|down) docker_down; ;;
        docker:restart|restart) docker_restart; ;;
        docker:logs|logs) shift; docker_logs "$@"; ;;
        docker:ps|ps) docker_ps; ;;
        docker:shell|shell) docker_shell; ;;
        docker:build|build) docker_build; ;;
        
        # Database
        db:init) db_init; ;;
        db:migrate) shift; db_migrate "$@"; ;;
        db:upgrade) db_upgrade; ;;
        db:downgrade) db_downgrade; ;;
        db:reset) db_reset; ;;
        
        # Users
        user:create) shift; user_create "$@"; ;;
        user:list) user_list; ;;
        user:delete) user_delete; ;;

        # Assets
        assets:build) assets_build; ;;
        assets:watch) assets_watch; ;;

        # Testing
        test) shift; test_run "$@"; ;;
        test:file) shift; test_file "$@"; ;;
        test:coverage) test_coverage; ;;
        lint) test_lint; ;;
        format) test_format; ;;
        
        # Development
        status) dev_status; ;;
        stats) dev_stats; ;;
        clean) dev_clean; ;;
        
        # Quick
        start) quick_start; ;;
        stop) quick_stop; ;;
        info) show_info; ;;
        
        # Help
        help|--help|-h) show_help; ;;
        *) error "Unknown command: $command"; show_help; exit 1; ;;
    esac
}

# Run main
main "$@"
