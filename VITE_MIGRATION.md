# Vite Migration Guide

## What Changed

We've migrated to Vite with Tailwind CSS v4 for building assets. This provides:

- **Faster builds** with hot module replacement (HMR)
- **Better developer experience** with instant updates
- **Unified build tool** for CSS and JS
- **Smaller CSS bundles** with Lightning CSS (9KB vs 23KB)
- **No config files needed** - Tailwind v4 uses CSS-based configuration

## Development

### Start development server with HMR:
```bash
make dev
```

This runs:
- Vite dev server on port 5173 (with HMR)
- Flask dev server on port 5000
- RQ worker with auto-reload

### Build assets only:
```bash
npm run build
```

### Watch assets only:
```bash
npm run dev
```

## How It Works

### Development Mode
- Vite dev server runs on `http://localhost:5173`
- Flask templates automatically use Vite dev server URLs
- Changes to CSS/JS trigger instant browser updates (HMR)
- No build step needed during development

### Production Mode
- Run `npm run build` to compile assets
- Vite generates optimized bundles in `resources/static/`
- Creates a manifest file at `resources/static/.vite/manifest.json`
- Flask reads manifest to get correct asset URLs

## Tailwind CSS v4

Tailwind v4 uses a new CSS-first approach:

```css
@import "tailwindcss";
@source "../../app/templates";  /* Scan templates for classes */

@layer components {
  .btn {
    @apply px-4 py-2 rounded-lg;
  }
}
```

**No more `tailwind.config.js`** - Configuration is done in CSS with `@source` directives.

## Template Usage

Assets are referenced using the `vite_asset()` helper:

```html
<!-- CSS -->
<link rel="stylesheet" href="{{ vite_asset('css/style.css') }}">

<!-- JavaScript -->
<script type="module" src="{{ vite_asset('js/main.js') }}"></script>

<!-- HMR Client (dev only) -->
{{ vite_hmr_client()|safe }}
```

## File Structure

```
resources/
├── assets/           # Source files (you edit these)
│   ├── css/
│   │   └── style.css (includes @source directive)
│   └── js/
│       └── main.js
└── static/           # Built files (generated by Vite)
    ├── .vite/
    │   └── manifest.json
    ├── css/
    │   └── style.min.css
    └── js/
        └── main.min.js
```

## Configuration Files

- `vite.config.js` - Vite build configuration with Tailwind plugin
- `app/utils/vite.py` - Flask helper functions

**Removed files:**
- ~~`tailwind.config.js`~~ - Not needed in Tailwind v4
- ~~`postcss.config.js`~~ - Vite handles CSS processing
- ~~`esbuild` config~~ - Replaced by Vite

## Docker

The Dockerfile has been updated to:
1. Copy `vite.config.js` to builder stage
2. Copy `app/templates/` for Tailwind content scanning
3. Run `npm run build` (which now uses Vite)
4. Copy built assets to final image

## Troubleshooting

### Assets not loading in development
- Ensure Vite dev server is running on port 5173
- Check `DEBUG=True` in Flask config
- Verify `VITE_DEV_SERVER` environment variable (default: `http://localhost:5173`)

### Assets not loading in production
- Run `npm run build` to generate assets
- Check `resources/static/.vite/manifest.json` exists
- Ensure `DEBUG=False` in Flask config

### Tailwind classes not working
- Ensure `@source "../../app/templates"` is in `resources/assets/css/style.css`
- Templates must be in `app/templates/` directory
- Rebuild assets with `npm run build`

### Port conflict
- Change Vite port in `vite.config.js` (server.port)
- Update `VITE_DEV_SERVER` environment variable if needed
