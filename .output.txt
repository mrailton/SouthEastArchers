Running tests with coverage...
Test session starts (platform: darwin, Python 3.14.2, pytest 9.0.2, pytest-sugar 1.1.1)
rootdir: /Users/mark/Projects/SouthEastArchers
configfile: pytest.ini
testpaths: tests
plugins: anyio-4.12.1, mock-3.15.1, flask-1.3.0, sugar-1.1.1, cov-7.0.0
collected 497 items
 tests/models/test_credit.py ✓✓✓✓✓✓                                1% ▎
 tests/models/test_event.py ✓✓✓✓✓✓✓✓✓✓                             3% ▍
 tests/models/test_membership.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓                   6% ▋
 tests/models/test_news.py ✓✓✓✓✓✓✓                                 8% ▊
 tests/models/test_payment.py ✓✓✓✓                                 8% ▉
 tests/models/test_shoot.py ✓✓✓✓                                   9% ▉
 tests/models/test_user.py ✓✓✓                                    10% █
 tests/routes/admin/test_dashboard.py ✓✓✓✓✓                       11% █▏
 tests/routes/admin/test_events.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓                 14% █▍
 tests/routes/admin/test_members.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓          18% █▊
 tests/routes/admin/test_members_additional.py ✓✓✓✓✓✓✓            19% █▉
 tests/routes/admin/test_news.py ✓✓✓✓✓✓✓✓✓✓✓✓✓                    22% ██▎
 tests/routes/admin/test_roles.py ✓✓✓✓✓✓✓✓✓✓✓✓                    24% ██▌
 tests/routes/admin/test_settings.py ✓✓✓✓✓✓✓✓✓✓                   26% ██▋
 tests/routes/admin/test_shoots.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓                29% ██▉
 tests/routes/test_auth.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓                         32% ███▎
 tests/routes/test_member.py ✓✓✓✓✓✓✓✓✓✓✓✓                         34% ███▌
 tests/routes/test_password_reset.py ✓✓✓✓✓✓✓✓✓✓                   36% ███▋
 tests/routes/test_payment.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓            41% ████▎
 tests/routes/test_public.py ✓✓✓✓✓✓✓✓✓✓✓✓                         44% ████▍
 tests/routes/test_validation_errors.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓            46% ████▋
 tests/services/test_mail_service.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓              49% ████▉
 tests/services/test_membership_service.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓       53% █████▍
――――――――――――――――――――――― test_renew_membership_exception ――――――――――――――――――――――――
tests/services/test_membership_service.py:348: in test_renew_membership_exception
    success, message = MembershipService.renew_membership(test_user)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/services/membership_service.py:40: in renew_membership
    settings = SettingsService.get()
               ^^^^^^^^^^^^^^^^^^^^^
app/services/settings_service.py:21: in get
    db.session.commit()
/opt/homebrew/Cellar/python@3.14/3.14.2_1/Frameworks/Python.framework/Versions/3.14/lib/python3.14/unittest/mock.py:1175: in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/opt/homebrew/Cellar/python@3.14/3.14.2_1/Frameworks/Python.framework/Versions/3.14/lib/python3.14/unittest/mock.py:1179: in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/opt/homebrew/Cellar/python@3.14/3.14.2_1/Frameworks/Python.framework/Versions/3.14/lib/python3.14/unittest/mock.py:1234: in _execute_mock_call
    raise effect
E   Exception: DB Error
 tests/services/test_membership_service.py ⨯✓                     53% █████▍
――――――――――――――――――――― test_expire_memberships_for_year_end ―――――――――――――――――――――
.venv/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2125: in _exec_insertmany_context
    dialect.do_execute(
.venv/lib/python3.14/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
E   sqlite3.IntegrityError: NOT NULL constraint failed: memberships.start_date
The above exception was the direct cause of the following exception:
tests/services/test_membership_service.py:374: in test_expire_memberships_for_year_end
    db.session.commit()
.venv/lib/python3.14/site-packages/sqlalchemy/orm/scoping.py:597: in commit
    return self._proxied.commit()
           ^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.14/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.14/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
.venv/lib/python3.14/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.14/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
.venv/lib/python3.14/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
.venv/lib/python3.14/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.14/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
.venv/lib/python3.14/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
.venv/lib/python3.14/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
.venv/lib/python3.14/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
.venv/lib/python3.14/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
.venv/lib/python3.14/site-packages/sqlalchemy/orm/persistence.py:1143: in _emit_insert_statements
    result = connection.execute(
.venv/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.14/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1844: in _execute_context
    return self._exec_insertmany_context(dialect, context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2133: in _exec_insertmany_context
    self._handle_dbapi_exception(
.venv/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2125: in _exec_insertmany_context
    dialect.do_execute(
.venv/lib/python3.14/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
E   sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) NOT NULL constraint failed: memberships.start_date
E   [SQL: INSERT INTO memberships (user_id, start_date, expiry_date, initial_credits, purchased_credits, status, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?) RETURNING id]
E   [parameters: (1, None, '2026-01-27', 10, 0, 'active', '2026-01-28 23:00:25.637380', '2026-01-28 23:00:25.637381')]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
 tests/services/test_membership_service.py ⨯                      53% █████▍
 tests/services/test_payment_finalizer.py ✓✓                      54% █████▍
 tests/services/test_payment_service.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓ 59% █████▉
 tests/services/test_rbac_service.py ✓✓✓✓✓✓✓                      60% ██████
 tests/services/test_settings_service.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓           63% ██████▍
 tests/services/test_sumup_service.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓   68% ██████▊
 tests/services/test_user_service.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓ 74% ███████▍
                                     ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓              77% ███████▋
 tests/test_app_factory.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓                    80% ████████▏
 tests/test_scheduler.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓ 89% ████████▉
                         ✓                                        89% ████████▉
 tests/test_scheduler_jobs.py ✓✓✓✓✓✓✓✓✓✓✓✓                        91% █████████▎
 tests/utils/test_decorators.py ✓✓✓✓✓✓                            92% █████████▎
――――――――――――――――――――――――― test_any_permission_required ―――――――――――――――――――――――――
/opt/homebrew/Cellar/python@3.14/3.14.2_1/Frameworks/Python.framework/Versions/3.14/lib/python3.14/unittest/mock.py:1617: in __enter__
    setattr(self.target, self.attribute, new_attr)
E   AttributeError: property 'is_authenticated' of 'User' object has no setter
During handling of the above exception, another exception occurred:
tests/utils/test_decorators.py:86: in test_any_permission_required
    with patch.object(admin_user, "is_authenticated", new=True):
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/opt/homebrew/Cellar/python@3.14/3.14.2_1/Frameworks/Python.framework/Versions/3.14/lib/python3.14/unittest/mock.py:1630: in __enter__
    if not self.__exit__(*sys.exc_info()):
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/opt/homebrew/Cellar/python@3.14/3.14.2_1/Frameworks/Python.framework/Versions/3.14/lib/python3.14/unittest/mock.py:1641: in __exit__
    delattr(self.target, self.attribute)
E   AttributeError: property 'is_authenticated' of 'User' object has no deleter
 tests/utils/test_decorators.py ⨯                                 93% █████████▍
 tests/utils/test_email.py ✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓                  97% █████████▋
 tests/utils/test_helpers.py ✓✓✓✓✓✓                               98% █████████▊
 tests/utils/test_vite.py ✓✓✓✓✓✓✓✓✓✓                             100% ██████████
================================ tests coverage ================================
_______________ coverage: platform darwin, python 3.14.2-final-0 _______________
Name                                         Stmts   Miss  Cover   Missing
--------------------------------------------------------------------------
app/__init__.py                                106      6    94%   91-95, 180
app/config.py                                   52      0   100%
app/forms/__init__.py                            4      0   100%
app/forms/admin_forms.py                        48      0   100%
app/forms/auth_forms.py                         18      0   100%
app/forms/member_forms.py                       10      0   100%
app/models/__init__.py                          10      0   100%
app/models/application_settings.py              14      1    93%   25
app/models/credit.py                            11      0   100%
app/models/event.py                             27      1    96%   28
app/models/membership.py                        48      0   100%
app/models/news.py                              17      0   100%
app/models/payment.py                           30      0   100%
app/models/rbac.py                              44      0   100%
app/models/shoot.py                             18      0   100%
app/models/user.py                              50      0   100%
app/routes/__init__.py                           6      0   100%
app/routes/admin/__init__.py                     3      0   100%
app/routes/admin/dashboard.py                    9      0   100%
app/routes/admin/events.py                      54      5    91%   40-41, 70, 85-86
app/routes/admin/members.py                    122      5    96%   71, 99-101, 150
app/routes/admin/news.py                        54      5    91%   39-40, 69, 83-84
app/routes/admin/roles.py                       74      0   100%
app/routes/admin/settings.py                    39      3    92%   51-53
app/routes/admin/shoots.py                      73     11    85%   43-46, 49, 89, 104-107, 115
app/routes/auth.py                              98      4    96%   144-145, 156-157
app/routes/member.py                            59      0   100%
app/routes/payment.py                           77      2    97%   71-72
app/routes/public.py                            26      0   100%
app/schedule.py                                 13     13     0%   1-21
app/scheduler/__init__.py                        4      0   100%
app/scheduler/event.py                         127     17    87%   104-105, 109-110, 114-115, 119-120, 124-125, 166, 175, 177, 182, 202-203, 207
app/scheduler/jobs/__init__.py                   3      0   100%
app/scheduler/jobs/expire_memberships.py        12      0   100%
app/scheduler/jobs/low_credits_reminder.py      29      2    93%   38-40
app/scheduler/schedule.py                       32      1    97%   36
app/services/__init__.py                        10      0   100%
app/services/admin_service.py                   12      0   100%
app/services/event_service.py                   43     10    77%   30-32, 53-55, 75-78
app/services/mail_service.py                    64      0   100%
app/services/membership_service.py              62     11    82%   46-48, 82-92
app/services/news_service.py                    39      6    85%   29-31, 53-55
app/services/payment_processing_service.py      89      2    98%   36-37
app/services/payment_service.py                 42      0   100%
app/services/rbac_service.py                    43      0   100%
app/services/settings_service.py                29      0   100%
app/services/shoot_service.py                   66      8    88%   47, 51-53, 95, 107-109
app/services/sumup_service.py                   81      3    96%   98-100
app/services/user_service.py                   138      0   100%
app/utils/__init__.py                            4      0   100%
app/utils/datetime_utils.py                      3      0   100%
app/utils/decorators.py                         36      5    86%   45-50
app/utils/email.py                              58      3    95%   147-149
app/utils/helpers.py                             9      0   100%
app/utils/session.py                             7      0   100%
app/utils/vite.py                               59      0   100%
--------------------------------------------------------------------------
TOTAL                                         2315    124    95%
Coverage HTML written to dir htmlcov
=========================== short test summary info ============================
FAILED tests/services/test_membership_service.py::test_renew_membership_exception - Exception: DB Error
FAILED tests/services/test_membership_service.py::test_expire_memberships_for_year_end - sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) NOT NULL constraint...
FAILED tests/utils/test_decorators.py::test_any_permission_required - AttributeError: property 'is_authenticated' of 'User' object has no deleter
Results (5.15s):
     494 passed
       3 failed
         - tests/services/test_membership_service.py:345 test_renew_membership_exception
         - tests/services/test_membership_service.py:361 test_expire_memberships_for_year_end
         - tests/utils/test_decorators.py:51 test_any_permission_required
HTML coverage report generated in htmlcov/
